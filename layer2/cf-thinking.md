

本文主要介绍个人在CounterFactual方面的学习和思考，以及通过CF我们可以做到什么。

CounterFactual（CF），翻译为中文为‘反事实’，源自心理学，是一种由已经发生的事实向事实起因反推，按照因果关系反推的一种逆向思考方法。在区块链的链外扩容技术中，CF指的是CounterFactual Instantiation，源自L4 Lab提出的一种基于状态通道的链外扩容技术，在区块链研究领域中被大家广泛学习，并推广为一类区块链扩容的设计思想。

CounterFactual Instantiation，指的是智能合约不需要在区块链进行实例化部署，而只需要部署到链外CF状态通道中。只要所有参与智能合约的用户都按照CF状态通道协议中定义的方式进行操作，状态通道中智能合约的执行结果和智能合约被部署到链上，两者是完全等价的关系。简单说就是，链外CF状态通道可以达到和链上相同的结果，注意这里的结果不仅是智能合约的状态数据，也包括区块链的trustless属性（核心为区块链的可追溯属性）。既然两者结果相同，考虑到区块链性能方面的局限性和链外方案的经济性，为什么不将多数的智能合约操作转移到链外完成。

在L4的白皮书中对CF的定义，也可以说CF状态通道协议的定义如下：
CF状态通道保证，对于任何链上操作X，如果用户通过CF的方式在状态通道中执行操作X，那么：

1. 操作X虽然在状态通道中完成的，如果用户愿意，也可以将其放在链上执行
2. 操作X在状态通道完成后，任何参与状态通道的人都可以将操作X同步到链上
3. 操作X在状态通道中完成后，参与状态通道的人可以等价地认为操作X的结果一定可以在链上完成终局

做为一个程序员，看到一个应用协议后，必然首先验证协议设计的完整性，分析协议的可行性，建立协议的应用边界，最后思考如何实现。

现在我们看CF状态通道的三点定义。

第一点定义了CF状态通道和区块链执行环境的等价性。任何状态通道中的操作在两者执行环境中必须是完全等价的，所以用户选择哪个执行环境是协议无关的；

第二点基于第一点，定义了CF状态通道的公平性和trustless，也可以说是CF状态通道的安全性。状态通道对于任何参与人都是公平的，每个操作引起的状态更新对于所有参与人都必须是可见和可验证的。基于第一点的操作等价性，任何人都可以直接将其同步到区块链上，因此对于状态通道参与人来说，CF状态通道安全性可以认为是和区块链等同的；

第三点定义了CF状态通道的一致性和终局性。状态通道中的操作和通道状态对于所有参与人必须是一致的，并且必须是即时终局的。这一点保证状态通道本身，在所有参与人的范围内的可追溯和不可篡改。

从上面三点分析，我们可以看出CF状态通道完全继承了区块链已有属性，比如一致性，不可篡改，安全性和终局性等，因此作为链外扩容方案，不会对区块链应用带来安全上的损失。
那么CF状态通道协议的应用边界是什么呢？


我们分析了CounterFactual状态通道的定义，并从中总结出等价性，公平性和一致性等属性。接下来，我们继续分析CF状态通道的三个定义，思考CounterFactual状态通道的应用边界。

第一个定义中的等价性要求。由于等价性是双向的，状态通道内智能合约的执行环境必须是状态通道和区块链的交集。这一点要求

1. 状态通道内所有操作X的输入信息只能来自操作X本身，对应的智能合约只能依赖于智能合约内部状态，而不可以依赖于任何区块链相关的信息（比如，区块链高度，区块时间等）。同时要求，在创建和初始化CF状态通道时，必须完成所有依赖信息的初始化，因为在CF状态通道运行过程中无法对区块链的链上状态进行锚定和访问。
2. 区块链和CF状态通道内对于操作X的处理方式必须一致。这是软件工程中比较坑的一点，由于软件不稳定性和区块链为保证不可篡改而独特的分叉升级方式，将会给CF状态通道带来一些小麻烦。在软件升级过程中，必须细心处理，或采用即时关闭CF状态通道的运维处理方式，以保证CF状态通道的等价性。
 

第二个定义中的公平性要求。在CF状态通道中的每个操作引起的状态更新对于所有参与人都必须是可见和可验证的。第一点首先定义CF状态通道为参与者固定的，并且是参与人的数目相对较少的，因此无法通过区块链中permissionless方式通过大量节点验证实现trustless。而需要所有参与人自己完成每个操作的状态更新的独立验证，通过所有参与人独立验证的方式实现trustless。这一点要求所有参与CF状态通道的用户必须自己运行状态通道验证服务，相比当前区块链用户要求略有提高，但是状态通道智能合约通常计算量很小，可以通过增强现有的区块链客户端程序实现。

第三个定义中的一致性和终局性要求。CF状态通道中的所有操作必须是一致的和即时终局的。在CF状态通道设计中，任何违法协议的用户行为都可以被惩罚，因此状态通道中的任何状态更新需要得到所有参与者的共同签名，以实现即时终局性。这一点要求所有参与者必须保持在线状态，以维护状态通道的运行。这一点对于简单应用或者短时应用不好有太大影响，但是对于复杂的涉及较多参与者的应用，将不得不采用类似代理节点或者守护节点的方式运行。

虽然我们目前只对CF状态通道的定义做出一些分析，我们可以总结出CF状态通道对其运行的智能合约的要求，和对状态通道参与者的要求。基于此，区块链应用开发者可以判断自己的应用是否更适合于CF状态通道的链外运行方式。

不止如此，CF状态通道虽然是一个区块链链外扩容的解决方案，我们更应该思考其中的设计方法。首先，从CF状态通道的协议中，我们可以清晰的看到crypto-economic系统设计要素，更重要的是，CounterFactual让我们看到了一种新的密码学应用方式。从更大的角度来看，每个区块链可以认为是现实世界的一个CF状态通道，所有参与到区块链的人在现实世界中锁定资产，参与到区块链网络的建设和验证；从更小的角度看，如何设计区块链应用以更好地将区块链和业务需求更好地融合在一起；甚至基于CounterFactual的思路有没有全新的业务模式？ 总之，CF状态通道设计是一个非常具有启发性的设计，带给我们一种全新的区块链系统设计方法。对于这种优秀的设计，我愿意给他90分。为什么不是100，只是担心他太骄傲：）

接下来，我们对CounterFactual的设计思想进一步推广，和大家一起思考CounterFactual给我们其他区块链设计带来的变化。


